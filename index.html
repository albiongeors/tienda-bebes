<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PEQUETHOBIAS - Ropa y Pañaleras para Bebés</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://unpkg.com/@supabase/supabase-js"></script>
    <style>
        /* ... (todos los estilos existentes) ... */

        /* Nuevos estilos para pagos */
        .payment-section {
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid #eee;
        }
        
        .payment-methods {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .payment-method {
            border: 2px solid #eee;
            border-radius: 10px;
            padding: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }
        
        .payment-method:hover, .payment-method.selected {
            border-color: var(--primary);
            background: rgba(255, 107, 139, 0.05);
        }
        
        .payment-method i {
            font-size: 2rem;
            margin-bottom: 0.5rem;
            color: var(--primary);
        }
        
        .payment-details {
            margin-top: 1.5rem;
            padding: 1.5rem;
            background: #f9f9f9;
            border-radius: 10px;
            display: none;
        }
        
        .payment-details.active {
            display: block;
        }
        
        .payment-instructions {
            margin-bottom: 1rem;
            padding: 1rem;
            background: #e3f2fd;
            border-radius: 8px;
        }
        
        .receipt-upload {
            margin-top: 1rem;
            padding: 1rem;
            border: 2px dashed #ddd;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
        }
        
        .receipt-upload:hover {
            border-color: var(--secondary);
        }
        
        .receipt-preview {
            max-width: 100%;
            max-height: 200px;
            margin-top: 1rem;
            display: none;
        }
        
        .payment-confirmation {
            margin-top: 1.5rem;
            padding: 1rem;
            background: #e8f5e9;
            border-radius: 8px;
            display: none;
        }
    </style>
</head>
<body>
    <!-- ... (todo el contenido existente) ... -->

    <!-- Modal de carrito -->
    <div class="modal-overlay" id="cart-modal">
        <div class="cart-modal">
            <div class="cart-header">
                <h2>Carrito de Compras</h2>
                <button class="close-modal" id="close-cart">&times;</button>
            </div>
            
            <div class="cart-items" id="cart-items">
                <!-- Los productos del carrito se mostrarán aquí -->
            </div>
            
            <div class="cart-summary">
                <div class="cart-total">
                    <span>Total:</span>
                    <span>$<span id="cart-total">0.00</span></span>
                </div>
                
                <!-- Sección de pagos -->
                <div class="payment-section">
                    <h3>Método de Pago</h3>
                    
                    <div class="payment-methods">
                        <div class="payment-method" data-method="pago_movil">
                            <i class="fas fa-mobile-alt"></i>
                            <h4>Pago Móvil</h4>
                            <p>Venezuela</p>
                        </div>
                        
                        <div class="payment-method" data-method="transferencia">
                            <i class="fas fa-university"></i>
                            <h4>Transferencia</h4>
                            <p>Bancaria</p>
                        </div>
                        
                        <div class="payment-method" data-method="zinli">
                            <i class="fas fa-wallet"></i>
                            <h4>Zinli</h4>
                            <p>Billetera digital</p>
                        </div>
                        
                        <div class="payment-method" data-method="kontigo">
                            <i class="fas fa-credit-card"></i>
                            <h4>Kontigo</h4>
                            <p>Tarjeta prepago</p>
                        </div>
                    </div>
                    
                    <!-- Detalles de cada método de pago -->
                    <div id="payment-details-container">
                        <!-- Los detalles se cargarán dinámicamente -->
                    </div>
                </div>
                
                <div class="cart-buttons">
                    <button class="btn" id="continue-shopping">Seguir Comprando</button>
                    <button class="btn btn-primary" id="checkout">Finalizar Compra</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuración de Supabase
        const SUPABASE_URL = 'https://sgpfgyoizwvlwnxdfczn.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNncGZneW9pend2bHdueGRmY3puIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1NTE5MTg1NywiZXhwIjoyMDcwNzY3ODU3fQ.BOEYOsT-shLG8CxqFgheAbbBF4Q8ot9VcHV06QczpKk';
        
        // Inicializar Supabase
        const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        // Variables globales
        let cart = [];
        let currentPage = 1;
        const productsPerPage = 8;
        let allProducts = [];
        let favorites = JSON.parse(localStorage.getItem('favorites')) || [];
        let currentCategory = 'all';
        let currentSearchTerm = '';

        // ... (funciones existentes) ...

        // Métodos de pago con sus detalles e instrucciones
        const paymentMethods = {
            pago_movil: {
                title: "Pago Móvil",
                instructions: `
                    <div class="payment-instructions">
                        <h4>Instrucciones para Pago Móvil:</h4>
                        <ol>
                            <li>Registra en tu banca móvil el siguiente número: <strong>0412-7430912</strong></li>
                            <li>Cédula: <strong>V-12345678</strong></li>
                            <li>Banco: <strong>Banesco</strong></li>
                            <li>Monto: <span class="payment-amount">$${total.toFixed(2)}</span></li>
                            <li>Envía el comprobante de pago</li>
                        </ol>
                    </div>
                `,
                fields: `
                    <div class="form-group">
                        <label for="pm-phone">Teléfono:</label>
                        <input type="tel" id="pm-phone" class="form-control" placeholder="0412-1234567" required>
                    </div>
                    <div class="form-group">
                        <label for="pm-id">Cédula:</label>
                        <input type="text" id="pm-id" class="form-control" placeholder="V-12345678" required>
                    </div>
                    <div class="form-group">
                        <label for="pm-bank">Banco:</label>
                        <select id="pm-bank" class="form-control" required>
                            <option value="">Selecciona un banco</option>
                            <option value="banesco">Banesco</option>
                            <option value="provincial">Provincial</option>
                            <option value="mercantil">Mercantil</option>
                            <option value="venezuela">Banco de Venezuela</option>
                        </select>
                    </div>
                `
            },
            transferencia: {
                title: "Transferencia Bancaria",
                instructions: `
                    <div class="payment-instructions">
                        <h4>Instrucciones para Transferencia:</h4>
                        <ol>
                            <li>Realiza una transferencia a nuestra cuenta bancaria</li>
                            <li>Banco: <strong>Banesco</strong></li>
                            <li>Tipo de cuenta: <strong>Corriente</strong></li>
                            <li>Número: <strong>0134-1234-1234-1234</strong></li>
                            <li>Titular: <strong>PEQUETHOBIAS C.A.</strong></li>
                            <li>RIF: <strong>J-123456789</strong></li>
                            <li>Monto: <span class="payment-amount">$${total.toFixed(2)}</span></li>
                            <li>Envía el comprobante de transferencia</li>
                        </ol>
                    </div>
                `,
                fields: `
                    <div class="form-group">
                        <label for="tf-bank">Banco Origen:</label>
                        <select id="tf-bank" class="form-control" required>
                            <option value="">Selecciona tu banco</option>
                            <option value="banesco">Banesco</option>
                            <option value="provincial">Provincial</option>
                            <option value="mercantil">Mercantil</option>
                            <option value="venezuela">Banco de Venezuela</option>
                            <option value="otro">Otro</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="tf-ref">Número de Referencia:</label>
                        <input type="text" id="tf-ref" class="form-control" placeholder="123456789" required>
                    </div>
                `
            },
            zinli: {
                title: "Zinli",
                instructions: `
                    <div class="payment-instructions">
                        <h4>Instrucciones para Zinli:</h4>
                        <ol>
                            <li>Envía el pago a nuestro correo: <strong>pequethobias@zinli.com</strong></li>
                            <li>Monto: <span class="payment-amount">$${total.toFixed(2)}</span></li>
                            <li>Envía el comprobante de la transacción</li>
                        </ol>
                    </div>
                `,
                fields: `
                    <div class="form-group">
                        <label for="zl-email">Tu correo de Zinli:</label>
                        <input type="email" id="zl-email" class="form-control" placeholder="tucorreo@example.com" required>
                    </div>
                `
            },
            kontigo: {
                title: "Kontigo",
                instructions: `
                    <div class="payment-instructions">
                        <h4>Instrucciones para Kontigo:</h4>
                        <ol>
                            <li>Realiza el pago a nuestro número de tarjeta</li>
                            <li>Tarjeta: <strong>1234 5678 9012 3456</strong></li>
                            <li>Titular: <strong>PEQUETHOBIAS C.A.</strong></li>
                            <li>Monto: <span class="payment-amount">$${total.toFixed(2)}</span></li>
                            <li>Envía el comprobante de la transacción</li>
                        </ol>
                    </div>
                `,
                fields: `
                    <div class="form-group">
                        <label for="kg-phone">Teléfono asociado a Kontigo:</label>
                        <input type="tel" id="kg-phone" class="form-control" placeholder="0412-1234567" required>
                    </div>
                `
            }
        };

        // Selección de método de pago
        document.querySelectorAll('.payment-method').forEach(method => {
            method.addEventListener('click', function() {
                // Deseleccionar todos
                document.querySelectorAll('.payment-method').forEach(m => {
                    m.classList.remove('selected');
                });
                
                // Seleccionar el actual
                this.classList.add('selected');
                
                const methodType = this.dataset.method;
                const paymentDetails = paymentMethods[methodType];
                const total = parseFloat(document.getElementById('cart-total').textContent);
                
                // Actualizar el monto en las instrucciones
                let instructions = paymentDetails.instructions.replace(
                    /\${total\.toFixed\(2\)}/g, 
                    total.toFixed(2)
                );
                
                // Mostrar detalles
                document.getElementById('payment-details-container').innerHTML = `
                    <h4>${paymentDetails.title}</h4>
                    ${instructions}
                    <div class="payment-fields">
                        ${paymentDetails.fields}
                        <div class="receipt-upload" id="receipt-upload">
                            <i class="fas fa-cloud-upload-alt"></i>
                            <p>Haz clic o arrastra aquí el comprobante de pago</p>
                            <p><small>Formatos: JPG, PNG, PDF (Máx. 5MB)</small></p>
                            <input type="file" id="payment-receipt" accept="image/*,.pdf" style="display: none;">
                            <img class="receipt-preview" id="receipt-preview">
                        </div>
                    </div>
                    <div class="payment-confirmation" id="payment-confirmation">
                        <i class="fas fa-check-circle"></i>
                        <p>Comprobante cargado correctamente</p>
                    </div>
                `;
                
                // Inicializar subida de comprobante
                initReceiptUpload();
            });
        });
        
        // Inicializar subida de comprobante
        function initReceiptUpload() {
            const receiptUpload = document.getElementById('receipt-upload');
            const receiptInput = document.getElementById('payment-receipt');
            const receiptPreview = document.getElementById('receipt-preview');
            const paymentConfirmation = document.getElementById('payment-confirmation');
            
            if (!receiptUpload) return;
            
            receiptUpload.addEventListener('click', () => {
                receiptInput.click();
            });
            
            receiptInput.addEventListener('change', function(e) {
                if (this.files && this.files[0]) {
                    const file = this.files[0];
                    
                    // Validar tamaño
                    if (file.size > 5 * 1024 * 1024) {
                        alert('El archivo es demasiado grande (Máx. 5MB)');
                        return;
                    }
                    
                    // Validar tipo
                    const validTypes = ['image/jpeg', 'image/png', 'application/pdf'];
                    if (!validTypes.includes(file.type)) {
                        alert('Formato no válido. Use JPG, PNG o PDF');
                        return;
                    }
                    
                    // Mostrar previsualización si es imagen
                    if (file.type.includes('image')) {
                        const reader = new FileReader();
                        
                        reader.onload = function(e) {
                            receiptPreview.src = e.target.result;
                            receiptPreview.style.display = 'block';
                        }
                        
                        reader.readAsDataURL(file);
                    }
                    
                    // Mostrar confirmación
                    paymentConfirmation.style.display = 'block';
                    
                    // Ocultar mensaje de subida
                    receiptUpload.querySelector('p').style.display = 'none';
                }
            });
            
            // Permitir arrastrar y soltar
            receiptUpload.addEventListener('dragover', (e) => {
                e.preventDefault();
                receiptUpload.style.borderColor = '#8BD3E6';
                receiptUpload.style.backgroundColor = 'rgba(139, 211, 230, 0.1)';
            });
            
            receiptUpload.addEventListener('dragleave', () => {
                receiptUpload.style.borderColor = '#ddd';
                receiptUpload.style.backgroundColor = '';
            });
            
            receiptUpload.addEventListener('drop', (e) => {
                e.preventDefault();
                receiptUpload.style.borderColor = '#ddd';
                receiptUpload.style.backgroundColor = '';
                
                if (e.dataTransfer.files && e.dataTransfer.files.length > 0) {
                    receiptInput.files = e.dataTransfer.files;
                    const event = new Event('change', { bubbles: true });
                    receiptInput.dispatchEvent(event);
                }
            });
        }
        
        // Finalizar compra con verificación manual
        document.getElementById('checkout').addEventListener('click', async function() {
            const selectedMethod = document.querySelector('.payment-method.selected');
            
            if (!selectedMethod) {
                alert('Por favor selecciona un método de pago');
                return;
            }
            
            const paymentMethod = selectedMethod.dataset.method;
            const receiptInput = document.getElementById('payment-receipt');
            
            if (!receiptInput || !receiptInput.files[0]) {
                alert('Por favor sube el comprobante de pago');
                return;
            }
            
            const receiptFile = receiptInput.files[0];
            const total = parseFloat(document.getElementById('cart-total').textContent);
            
            // Recolectar datos específicos del método
            let paymentDetails = {};
            switch (paymentMethod) {
                case 'pago_movil':
                    paymentDetails = {
                        telefono: document.getElementById('pm-phone').value,
                        cedula: document.getElementById('pm-id').value,
                        banco: document.getElementById('pm-bank').value
                    };
                    break;
                case 'transferencia':
                    paymentDetails = {
                        banco_origen: document.getElementById('tf-bank').value,
                        referencia: document.getElementById('tf-ref').value
                    };
                    break;
                case 'zinli':
                    paymentDetails = {
                        email: document.getElementById('zl-email').value
                    };
                    break;
                case 'kontigo':
                    paymentDetails = {
                        telefono: document.getElementById('kg-phone').value
                    };
                    break;
            }
            
            // Subir el comprobante
            const receiptFileName = `receipt_${Date.now()}_${receiptFile.name}`;
            const { data: receiptData, error: receiptError } = await supabase
                .storage
                .from('payment-receipts')
                .upload(receiptFileName, receiptFile);
            
            if (receiptError) {
                console.error('Error subiendo comprobante:', receiptError);
                alert('Error al subir el comprobante. Intente de nuevo.');
                return;
            }
            
            // Obtener URL del comprobante
            const { data: { publicUrl } } = supabase
                .storage
                .from('payment-receipts')
                .getPublicUrl(receiptFileName);
            
            // Crear el pedido
            const orderData = {
                total: total,
                items: cart,
                payment_method: paymentMethod,
                payment_details: paymentDetails,
                receipt_url: publicUrl,
                status: 'pending_verification'
            };
            
            const { data: order, error: orderError } = await supabase
                .from('orders')
                .insert([orderData])
                .select();
            
            if (orderError) {
                console.error('Error creando pedido:', orderError);
                alert('Error al procesar tu pedido. Por favor, inténtalo de nuevo.');
                return;
            }
            
            // Mostrar confirmación
            alert(`¡Pedido #${order[0].id} creado con éxito! 
                   Estamos verificando tu pago. Te notificaremos cuando sea confirmado.`);
            
            // Limpiar carrito
            cart = [];
            updateCartCount();
            closeCart();
            
            // Trackeo de evento
            trackEvent('purchase', {
                transaction_id: order[0].id,
                value: total,
                items: cart.length,
                payment_method: paymentMethod
            });
        });
    </script>
</body>
</html>

